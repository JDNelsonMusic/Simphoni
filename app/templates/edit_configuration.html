<!-- app/templates/edit_configuration.html -->
{% extends "base.html" %}

{% block title %}Edit Configuration{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.view_configuration', config_id=configuration.id) }}">View Configuration</a></li>
            <li class="breadcrumb-item active" aria-current="page">Edit Configuration</li>
        </ol>
    </nav>

    <!-- Edit Configuration Form -->
    <h2>Edit Configuration</h2>
    <form method="POST" action="{{ url_for('main.edit_configuration', config_id=configuration.id) }}">
        {{ form.hidden_tag() }} <!-- Renders hidden fields like CSRF token -->

        <!-- Configuration Name -->
        <div class="mb-3">
            {{ form.config_name.label(class="form-label") }}
            {{ form.config_name(class="form-control", placeholder="Enter a name for this configuration") }}
            {% if form.config_name.errors %}
                <div class="text-danger">
                    {% for error in form.config_name.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Number of Inferences -->
        <div class="mb-4">
            {{ form.inference_count.label(class="form-label") }}
            <div class="d-flex gap-3">
                {{ form.inference_count(class="form-control", min="1", max="100") }}
                <!-- Alternatively, use radio buttons or a dropdown if preferred -->
            </div>
            {% if form.inference_count.errors %}
                <div class="text-danger">
                    {% for error in form.inference_count.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Available Functions -->
        <div class="mb-4">
            <h4>Available Functions</h4>
            <div id="available-functions" class="d-flex flex-wrap gap-2">
                {% for slot_num in range(1,10) %}
                    {% set slot_id = 'slot_' ~ slot_num|string %}
                    <div class="available-function badge bg-secondary p-2 draggable" draggable="true" data-slot-id="{{ slot_id }}">
                        {% if models_info.get(slot_id) and models_info[slot_id].get('nickname') %}
                            {{ models_info[slot_id]['nickname'] }}
                        {% else %}
                            Slot{{ slot_num }}
                        {% endif %}
                    </div>
                {% endfor %}
                <!-- OmniCall Function -->
                <div class="available-function badge bg-info p-2 draggable" draggable="true" data-function="omnicall">
                    OmniCall
                </div>
            </div>
        </div>

        <!-- Arrange Model Sequence -->
        <div class="mb-4">
            <h4>Arrange Model Sequence:</h4>
            <p>Drag and drop to arrange the order of model slots. You can insert OmniCall multiple times.</p>
            <ul id="model-order" class="list-group mb-3">
                {% if model_order and model_order|length > 0 %}
                    {% for idx, slot in enumerate(model_order, start=1) %}
                        <li class="list-group-item d-flex align-items-center" draggable="true">
                            <span class="badge bg-primary me-2">{{ idx }}</span>
                            <span class="flex-grow-1 slot-content">{{ slot }}</span>
                            <button type="button" class="btn btn-sm btn-danger remove-slot" title="Remove Slot">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </li>
                    {% endfor %}
                {% else %}
                    <!-- Default slots if no model_order is set -->
                    {% for slot_num in range(1,19) %}
                        <li class="list-group-item d-flex align-items-center" draggable="true">
                            <span class="badge bg-primary me-2">{{ slot_num }}</span>
                            <span class="flex-grow-1 slot-content"></span>
                            <button type="button" class="btn btn-sm btn-danger remove-slot" title="Remove Slot">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>
            {{ form.model_order(id='model_order') }} <!-- Hidden input for model_order -->
        </div>

        <!-- Save Configuration Button -->
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Save Changes
        </button>
        <a href="{{ url_for('main.view_configuration', config_id=configuration.id) }}" class="btn btn-secondary ms-2">
            <i class="bi bi-arrow-left"></i> Cancel
        </a>
    </form>
</div>

<!-- Drag-and-Drop Script -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modelOrderInput = document.getElementById('model_order'); // Hidden input for model_order
        const modelOrderList = document.getElementById('model-order');
        const availableFunctions = document.getElementById('available-functions');

        // Function to update the hidden input based on current model order
        function updateModelOrderInput() {
            const slots = modelOrderList.querySelectorAll('.list-group-item .slot-content');
            const order = Array.from(slots).map(slot => slot.textContent.trim()).filter(name => name !== '');
            modelOrderInput.value = JSON.stringify(order);
        }

        // Initialize model order input
        updateModelOrderInput();

        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-slot').forEach(button => {
            button.addEventListener('click', () => {
                button.closest('.list-group-item').remove();
                updateModelOrderInput();
            });
        });

        // Drag and Drop Handlers for Model Order List
        let draggedItem = null;

        modelOrderList.addEventListener('dragstart', (e) => {
            draggedItem = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedItem.outerHTML);
            draggedItem.classList.add('dragging');
        });

        modelOrderList.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const target = e.target.closest('.list-group-item');
            if (target && target !== draggedItem) {
                modelOrderList.insertBefore(draggedItem, target.nextSibling);
            }
        });

        modelOrderList.addEventListener('dragend', () => {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
            updateModelOrderInput();
        });

        // Drag and Drop Handlers for Available Functions
        availableFunctions.querySelectorAll('.draggable').forEach(func => {
            func.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', func.dataset.slotId || func.dataset.function || '');
                e.dataTransfer.effectAllowed = 'copyMove';
            });
        });

        modelOrderList.addEventListener('drop', (e) => {
            e.preventDefault();
            const data = e.dataTransfer.getData('text/plain');
            let slotName = '';

            if (data.startsWith('slot_')) {
                // It's a model slot from Available Functions
                const funcElement = availableFunctions.querySelector(`.available-function[data-slot-id="${data}"]`);
                slotName = funcElement ? funcElement.textContent.trim() : 'Unknown Function';
            } else if (data === 'omnicall') {
                // It's OmniCall
                slotName = 'OmniCall';
            }

            if (slotName) {
                const newItem = document.createElement('li');
                newItem.classList.add('list-group-item', 'd-flex', 'align-items-center');
                newItem.setAttribute('draggable', 'true');

                const badge = document.createElement('span');
                badge.classList.add('badge', 'bg-primary', 'me-2');
                badge.textContent = modelOrderList.children.length + 1;

                const slotContent = document.createElement('span');
                slotContent.classList.add('flex-grow-1', 'slot-content');
                slotContent.textContent = slotName;

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.classList.add('btn', 'btn-sm', 'btn-danger', 'remove-slot');
                removeBtn.title = 'Remove Slot';
                removeBtn.innerHTML = '<i class="bi bi-x-circle"></i>';

                // Append elements
                newItem.appendChild(badge);
                newItem.appendChild(slotContent);
                newItem.appendChild(removeBtn);
                modelOrderList.appendChild(newItem);

                // Add event listener to the new remove button
                removeBtn.addEventListener('click', () => {
                    newItem.remove();
                    updateModelOrderInput();
                });

                // Add drag event listeners to the new item
                newItem.addEventListener('dragstart', (e) => {
                    draggedItem = newItem;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', draggedItem.outerHTML);
                    newItem.classList.add('dragging');
                });

                newItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const target = e.target.closest('.list-group-item');
                    if (target && target !== draggedItem) {
                        modelOrderList.insertBefore(draggedItem, target.nextSibling);
                    }
                });

                newItem.addEventListener('dragend', () => {
                    newItem.classList.remove('dragging');
                    draggedItem = null;
                    updateModelOrderInput();
                });

                updateModelOrderInput();
            }
        });

        // Initial setup for draggable list items
        modelOrderList.querySelectorAll('.list-group-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', draggedItem.outerHTML);
                item.classList.add('dragging');
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const target = e.target.closest('.list-group-item');
                if (target && target !== draggedItem) {
                    modelOrderList.insertBefore(draggedItem, target.nextSibling);
                }
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                draggedItem = null;
                updateModelOrderInput();
            });
        });
    });
</script>
{% endblock %}
